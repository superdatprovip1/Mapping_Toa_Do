<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toa Do ‚Üí Map Viewer (Autoload + Preview Route + PWA)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

  <style>
    :root { --pad: 10px; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #toolbar { position:sticky; top:0; z-index:1000; background:white; padding: var(--pad); display:flex; flex-wrap: wrap; gap:10px; align-items:end; box-shadow: 0 1px 0 rgba(0,0,0,.08); }
    #map { position: absolute; top: 140px; bottom: 0; left: 0; right: 0; }
    .card { border:1px solid #e6e6e6; border-radius: 10px; padding: 10px; }
    button, select, label.toggle { padding:8px 10px; border-radius:8px; border:1px solid #d0d7de; font-size: 13px; background:#111827; color:#fff; cursor:pointer; }
    select { background:#111827; color:#fff; }
    .stats { font-size:12px; color:#111; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; }
    .btn-ghost { background:#f8fafc; color:#111; border-color:#e5e7eb; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="card">
      <div><b>D·ªØ li·ªáu autoload t·ª´:</b> <code>data/toado.csv</code></div>
      <div id="statBox" class="stats"></div>
    </div>
    <div class="card">
      <button id="btnReload">üîÑ T·∫£i l·∫°i d·ªØ li·ªáu</button>
      <button id="btnMyLoc">üìç L·∫•y v·ªã tr√≠ c·ªßa t√¥i</button>
      <select id="navPref">
        <option value="auto">T·ª± ƒë·ªông (iOS‚ÜíApple, Android‚ÜíGoogle)</option>
        <option value="google">Google Maps</option>
        <option value="apple">Apple Maps</option>
        <option value="osm">OpenStreetMap</option>
      </select>
      <label class="toggle">
        <input type="checkbox" id="previewToggle" checked style="margin-right:6px"> Xem tr∆∞·ªõc l·ªô tr√¨nh
      </label>
    </div>
  </div>

  <div id="map"></div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    let map, markers, heatLayer, myMarker, myCircle, routingCtrl=null, table=[];
    const statBox = document.getElementById('statBox');
    const navPref = document.getElementById('navPref');
    const previewToggle = document.getElementById('previewToggle');
    const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
    let myLoc = null;

    function initMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'}).addTo(map);
      map.setView([16.047,108.206],5);
    }
    function fmt(n){ return Number(n).toFixed(6); }

    // Parser: h·ªó tr·ª£ d·∫•u ph·∫©y/ch·∫•m v√† m·ªçi ki·ªÉu ph√¢n t√°ch
    function parseCoordText(s){
      if (s==null) return null;
      const m = String(s).trim().match(/-?\d+(?:[.,]\d+)?/g);
      if (!m || m.length<2) return null;
      const la = parseFloat(m[0].replace(',','.'));
      const lo = parseFloat(m[1].replace(',','.'));
      if (Number.isNaN(la)||Number.isNaN(lo)) return null;
      if (la<-90||la>90||lo<-180||lo>180) return null;
      return [la,lo];
    }

    function buildExternalNavLink(lat, lon){
      const choice = navPref.value==='auto' ? (isIOS?'apple':'google') : navPref.value;
      const d = `${fmt(lat)},${fmt(lon)}`;
      if (choice==='google') return `https://www.google.com/maps/dir/?api=1&destination=${d}`;
      if (choice==='apple')  return `https://maps.apple.com/?daddr=${d}&dirflg=d`;
      return `https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&to=${d}`;
    }

    function ensureRoutingCleared(){
      if (routingCtrl){ map.removeControl(routingCtrl); routingCtrl=null; }
    }
    function previewRouteTo(destLat, destLon){
      ensureRoutingCleared();
      if (!myLoc){ alert('H√£y b·∫•m "üìç L·∫•y v·ªã tr√≠ c·ªßa t√¥i" tr∆∞·ªõc khi xem tr∆∞·ªõc l·ªô tr√¨nh.'); return; }
      routingCtrl = L.Routing.control({
        waypoints: [ L.latLng(myLoc.lat, myLoc.lon), L.latLng(destLat, destLon) ],
        routeWhileDragging: false,
        addWaypoints: false,
        collapsible: true,
        showAlternatives: false,
        fitSelectedRoutes: true,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
      }).addTo(map);
    }

    function makePopup(lat, lon){
      const url = buildExternalNavLink(lat, lon);
      const btnPreview = previewToggle.checked
        ? `<button class="btn-ghost preview-route" data-lat="${lat}" data-lon="${lon}" style="margin-left:6px">üëÄ Xem tr∆∞·ªõc</button>`
        : '';
      return `
        <div style="min-width:220px">
          <b>ƒêi·ªÉm ƒë·∫øn</b><br>Lat: ${fmt(lat)}<br>Lon: ${fmt(lon)}
          <div style="margin-top:8px">
            <a href="${url}" target="_blank" rel="noopener"><button>üß≠ Ch·ªâ ƒë∆∞·ªùng</button></a>
            ${btnPreview}
          </div>
        </div>`;
    }

    function clearLayers(){
      if (markers){ map.removeLayer(markers); markers=null; }
      if (heatLayer){ map.removeLayer(heatLayer); heatLayer=null; }
      ensureRoutingCleared();
    }

    function render(){
      clearLayers();
      const cols = table.length? Object.keys(table[0]) : [];
      const pickCol = cols.find(c => parseCoordText(table[0][c])) || cols[0];
      let pts=[], bad=0;
      for (const row of table){
        const p = parseCoordText(row[pickCol]);
        if (p) pts.push(p); else bad++;
      }

      markers = L.markerClusterGroup();
      pts.forEach(([la,lo]) => {
        // bindPopup NGAY khi t·∫°o marker
        const m = L.marker([la,lo]).bindPopup(makePopup(la,lo));
        m.on('popupopen', (ev) => {
          // M·ªói l·∫ßn m·ªü, c·∫≠p nh·∫≠t content theo tr·∫°ng th√°i hi·ªán t·∫°i
          const { lat, lng } = ev.popup.getLatLng();
          ev.popup.setContent(makePopup(lat, lng));
          ev.popup.update();

          // G·∫Øn handler cho n√∫t üëÄ n·∫øu c√≥
          const btn = ev.popup.getElement().querySelector('.preview-route');
          if (btn){
            btn.addEventListener('click', () => {
              const dlat = parseFloat(btn.getAttribute('data-lat'));
              const dlon = parseFloat(btn.getAttribute('data-lon'));
              previewRouteTo(dlat, dlon);
            });
          }
        });
        markers.addLayer(m);
      });
      map.addLayer(markers);

      heatLayer = L.heatLayer(pts.map(p=>[p[0],p[1],0.6]), {radius:18, blur:16, maxZoom:17}).addTo(map);
      if (pts.length) map.fitBounds(L.latLngBounds(pts), {padding:[20,20]});
      statBox.innerHTML = `<b>ƒêi·ªÉm h·ª£p l·ªá:</b> ${pts.length} ¬∑ <b>Sai ƒë·ªãnh d·∫°ng:</b> ${bad} ¬∑ <span class="pill">C·ªôt d√πng: ${pickCol||'-'}</span>`;
    }

    async function loadCSV(){
      const url = `data/toado.csv?t=${Date.now()}`; // lu√¥n l·∫•y m·ªõi
      const text = await fetch(url, {cache:"no-store"}).then(r=>{
        if (!r.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c data/toado.csv");
        return r.text();
      });
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
      table = parsed.data;
      render();
    }

    document.getElementById('btnReload').addEventListener('click', loadCSV);

    document.getElementById('btnMyLoc').addEventListener('click', ()=>{
      if (!navigator.geolocation){ alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude, accuracy} = pos.coords;
        myLoc = {lat: latitude, lon: longitude};
        if (myMarker) map.removeLayer(myMarker);
        if (myCircle) map.removeLayer(myCircle);
        myMarker = L.marker([latitude, longitude]).addTo(map)
          .bindPopup(`B·∫°n ƒëang ·ªü ƒë√¢y<br>Lat: ${fmt(latitude)}<br>Lon: ${fmt(longitude)}<br>¬±${Math.round(accuracy||0)}m`).openPopup();
        if (accuracy) myCircle = L.circle([latitude, longitude], {radius:accuracy, color:'#2563eb', fillColor:'#60a5fa', fillOpacity:0.15}).addTo(map);
        map.setView([latitude, longitude], 15);
      }, (err)=>alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: '+err.message), {enableHighAccuracy:true, timeout:15000, maximumAge:0});
    });

    // Khi ƒë·ªïi tu·ª≥ ch·ªçn preview ho·∫∑c app d·∫´n ƒë∆∞·ªùng: c·∫≠p nh·∫≠t popup ƒëang m·ªü
    function refreshOpenPopup(){
      ensureRoutingCleared();
      const p = map._popup;
      if (p && p.getLatLng){
        const ll = p.getLatLng();
        p.setContent(makePopup(ll.lat, ll.lng));
        p.update();
      }
    }
    previewToggle.addEventListener('change', refreshOpenPopup);
    navPref.addEventListener('change', refreshOpenPopup);

    // Init
    initMap();
    loadCSV().catch(e=> statBox.textContent = e.message);

    // SW (n·∫øu c·∫ßn √©p c·∫≠p nh·∫≠t, ƒë·ªïi version trong sw.js v√† th√™m ?v=xx ·ªü URL)
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
  </script>
</body>
</html>
