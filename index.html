<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toa Do ‚Üí Map Viewer (PWA + Live Directions)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

  <style>
    :root { --pad: 10px; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #toolbar { position:sticky; top:0; z-index:1000; background:white; padding: var(--pad); display:flex; flex-wrap: wrap; gap:10px; align-items:end; box-shadow: 0 1px 0 rgba(0,0,0,.08); }
    #map { position: absolute; top: 160px; bottom: 0; left: 0; right: 0; }
    .card { border:1px solid #e6e6e6; border-radius: 10px; padding: 10px; }
    label { font-size: 12px; color:#333; display:block; margin-bottom:6px; }
    input[type="file"], select, button { padding:8px 10px; border-radius:8px; border:1px solid #d0d7de; font-size: 13px; }
    button { background:#111827; color:white; cursor:pointer; }
    .note { font-size:12px; color:#666; margin-top:6px; }
    .stats { font-size:12px; color:#111; }
    .stats b { font-weight:600; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="card">
      <label>Ch·ªçn file Excel/CSV (ch·ªâ 1 c·ªôt <b>Toa Do</b> d·∫°ng "lat lon")</label>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
      <div class="note">V√≠ d·ª•: <code>21.192572 106.090198</code> ho·∫∑c <code>21.192572,106.090198</code></div>
    </div>

    <div class="card">
      <label>C·ªôt "Toa Do"</label>
      <select id="coordCol"></select>
    </div>

    <div class="card">
      <label>T√πy ch·ªçn</label>
      <div><label><input type="checkbox" id="dedup" checked> Lo·∫°i tr√πng (Lat,Lon)</label></div>
      <div><label><input type="checkbox" id="showHeat" checked> Heatmap</label></div>
      <div><label><input type="checkbox" id="showCluster" checked> Cluster</label></div>
    </div>

    <div class="card">
      <button id="btnMyLoc">üìç L·∫•y v·ªã tr√≠ c·ªßa t√¥i</button>
      <button id="btnRender" disabled>V·∫Ω b·∫£n ƒë·ªì</button>
      <div id="statBox" class="stats" style="margin-top:8px;"></div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    let table = [];
    let columns = [];
    let map, osm, markers, heatLayer;
    let myMarker = null, myCircle = null;

    const fileInput = document.getElementById('fileInput');
    const coordSel = document.getElementById('coordCol');
    const btn = document.getElementById('btnRender');
    const btnMyLoc = document.getElementById('btnMyLoc');
    const statBox = document.getElementById('statBox');

    let myLoc = null;
    const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
    const defaultApp = isIOS ? 'apple' : 'google';

    function initMap() {
      map = L.map('map');
      osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      map.setView([16.047, 108.206], 5);
    }

    function clearLayers() {
      if (markers) { map.removeLayer(markers); markers = null; }
      if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
    }

    async function readCSV(file) {
      return new Promise((resolve) => {
        Papa.parse(file, { header: true, skipEmptyLines: true, complete: (res) => resolve(res.data) });
      });
    }

    async function readXLSX(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          resolve(json);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const ext = file.name.split('.').pop().toLowerCase();
      table = ext === 'csv' ? await readCSV(file) : await readXLSX(file);
      columns = table.length ? Object.keys(table[0]) : [];
      coordSel.innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join('');
      btn.disabled = !(columns.length > 0);
      statBox.textContent = '';
    });

    function parseCoordText(s) {
      if (!s) return null;
      const m = String(s).trim().match(/(-?\d+(?:\.\d+)?)\s*[ ,]\s*(-?\d+(?:\.\d+)?)/);
      if (!m) return null;
      return [parseFloat(m[1]), parseFloat(m[2])];
    }

    function buildExternalNavLink(destLat, destLon) {
      const d = `${destLat},${destLon}`;
      if (defaultApp === 'google') {
        return `https://www.google.com/maps/dir/?api=1&destination=${d}`;
      } else {
        return `https://maps.apple.com/?daddr=${d}&dirflg=d`;
      }
    }

    function makePopup(lat, lon) {
      const url = buildExternalNavLink(lat, lon);
      return `<b>ƒêi·ªÉm ƒë·∫øn</b><br>Lat: ${lat}<br>Lon: ${lon}<br><a href="${url}" target="_blank"><button>üß≠ Ch·ªâ ƒë∆∞·ªùng</button></a>`;
    }

    function render() {
      clearLayers();
      let pts = [];
      for (const row of table) {
        const parsed = parseCoordText(row[coordSel.value]);
        if (parsed) pts.push(parsed);
      }
      markers = L.markerClusterGroup();
      pts.forEach(([la,lo]) => markers.addLayer(L.marker([la,lo]).bindPopup(makePopup(la,lo))));
      map.addLayer(markers);
      if (pts.length) map.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
      statBox.textContent = `ƒê√£ load ${pts.length} ƒëi·ªÉm.`;
    }

    btn.addEventListener('click', render);

    btnMyLoc.addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        myLoc = { lat: latitude, lon: longitude };
        if (myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([latitude, longitude], { title: 'V·ªã tr√≠ c·ªßa t√¥i' }).addTo(map).bindPopup("B·∫°n ƒëang ·ªü ƒë√¢y").openPopup();
        map.setView([latitude, longitude], 15);
      }, (err) => alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: ' + err.message));
    });

    initMap();

    // ƒêƒÉng k√Ω service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
